<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sliders Example (Unique Box Keys)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between; /* Ensure elements are aligned horizontally */
            margin-bottom: 20px;
        }
        .header label {
            font-size: 16px;
            margin-right: 10px; /* Add margin for spacing */
        }
        .header input[type="text"] {
            font-size: 16px;
            padding: 10px;
            width: 300px; /* Set a fixed width */
        }
        .buttons-container {
            display: flex;
            gap: 10px;
            align-items: center; /* Vertical center alignment */
        }
        /* Container to hold the boxes */
        #boxes-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Exactly 4 columns */
            gap: 20px; /* Reduced gap between boxes */
            width: 90%; /* Use 90% of the screen width */
            max-width: 1200px; /* Optional: limit maximum width for better layout control */
        }
        .box {
            padding: 5px; /* Reduced padding */
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            height: auto; /* Adjust height */
        }
        .slider-container {
            text-align: center;
            width: 100%;
            margin-bottom: 5px; /* Reduced margin */
            position: relative;
        }
        .slider-title {
            font-size: 12px; /* Reduced font size */
            margin-bottom: 5px; /* Reduced margin */
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            position: relative;
            z-index: 2;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: var(--slider-thumb-color, #4CAF50);
            cursor: pointer;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            position: relative;
            z-index: 3;
        }
        input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: var(--slider-thumb-color, #4CAF50);
            cursor: pointer;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            position: relative;
            z-index: 3;
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 10px;
        }
        .ideal-range {
            position: absolute;
            top: 40%;
            height: 20px; /* Reduced height */
            border: 2px dotted green;
            background-color: rgba(144, 238, 144, 0.3);
            z-index: 1;
            transform: translateY(-20%);
        }
    </style>
</head>
<body>
    <div class="header">
        <label for="title">Title:</label>
        <input type="text" id="title" placeholder="Enter Title">
        <div class="buttons-container">
            <!-- Save button -->
            <button id="saveButton">Save</button>

            <!-- Dropdown for saved data -->
            <select id="savedDataList"></select>

            <!-- Retrieve button -->
            <button id="retrieveDataButton">Retrieve Data</button>

            <!-- Clear Fields -->
            <button id="clearButton">Clear Fields</button>

            <!-- Delete Data -->
            <button id="deleteDataButton">Delete Data</button>
        </div>
    </div>

    <!-- Template for a single box -->
    <template id="box-template">
        <div class="box">
            <div class="slider-container">
                <div class="slider-title">
                    Check<span class="sequence-number">1</span>
                </div>
                <div>
                    <label for="datetime">Date/Time:</label>
                    <input type="datetime-local" class="datetime-picker">
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Temperature: <span class="temperature-value">65</span>°F
                    </div>
                    <div class="ideal-range" 
                         style="left: calc((78 - 65) / (90 - 65) * 100%); 
                                width: calc((82 - 78) / (90 - 65) * 100%);">
                    </div>
                    <input type="range" min="65" max="90" value="65" 
                           class="temperature-slider" step="1"
                           data-ideal-min="78" data-ideal-max="82">
                    <div class="slider-labels">
                        <span>65°F</span>
                        <span>70°F</span>
                        <span>75°F</span>
                        <span>80°F</span>
                        <span>85°F</span>
                        <span>90°F</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Time: <span class="time-value">0</span> hrs
                    </div>
                    <div class="ideal-range" 
                         style="left: calc((3.5 - 0) / (8 - 0) * 100%);
                                width: calc((4.5 - 3.5) / (8 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="8" value="0" 
                           class="time-slider" step="0.25"
                           data-ideal-min="3.5" data-ideal-max="4.5">
                    <div class="slider-labels">
                        <span>0 hrs</span>
                        <span>1 hr</span>
                        <span>2 hrs</span>
                        <span>3 hrs</span>
                        <span>4 hrs</span>
                        <span>5 hrs</span>
                        <span>6 hrs</span>
                        <span>7 hrs</span>
                        <span>8 hrs</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Percent Rise: <span class="percent-rise-value">0</span>%
                    </div>
                    <div class="ideal-range" 
                         style="left: calc((20 - 0) / (100 - 0) * 100%);
                                width: calc((30 - 20) / (100 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="100" value="0" 
                           class="percent-rise-slider" step="1"
                           data-ideal-min="20" data-ideal-max="30">
                    <div class="slider-labels">
                        <span>0%</span>
                        <span>20%</span>
                        <span>40%</span>
                        <span>60%</span>
                        <span>80%</span>
                        <span>100%</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Domed on Top: <span class="domed-on-top-value">Flat</span>
                    </div>
                    <div class="ideal-range"
                         style="left: calc((1 - 0) / (4 - 0) * 100%);
                                width: calc((3 - 1) / (4 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="4" value="0"
                           class="domed-on-top-slider" step="0.01"
                           data-ideal-min="1" data-ideal-max="3">
                    <div class="slider-labels">
                        <span>Flat</span>
                        <span>Low</span>
                        <span>High</span>
                        <span>Deflated</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Bubbles on Top: <span class="bubbles-on-top-value">None</span>
                    </div>
                    <div class="ideal-range"
                         style="left: calc((1 - 0) / (3 - 0) * 100%);
                                width: calc((2 - 1) / (3 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="3" value="0"
                           class="bubbles-on-top-slider" step="0.01"
                           data-ideal-min="1" data-ideal-max="2">
                    <div class="slider-labels">
                        <span>None</span>
                        <span>Few</span>
                        <span>Many</span>
                        <span>Deflated</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Bubbles on Sides: <span class="bubbles-on-sides-value">None</span>
                    </div>
                    <div class="ideal-range"
                         style="left: calc((1 - 0) / (3 - 0) * 100%);
                                width: calc((2 - 1) / (3 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="3" value="0"
                           class="bubbles-on-sides-slider" step="0.01"
                           data-ideal-min="1" data-ideal-max="2">
                    <div class="slider-labels">
                        <span>None</span>
                        <span>Few</span>
                        <span>Many</span>
                        <span>Deflated</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Wobble Test: <span class="wobble-test-value">Stiff</span>
                    </div>
                    <div class="ideal-range"
                         style="left: calc((0.5 - 0) / (2 - 0) * 100%);
                                width: calc((1.5 - 0.5) / (2 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="2" value="0"
                           class="wobble-test-slider" step="0.01"
                           data-ideal-min="0.5" data-ideal-max="1.5">
                    <div class="slider-labels">
                        <span>Stiff</span>
                        <span>Loose and Aerated</span>
                        <span>Liquified</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Windowpane: <span class="windowpane-value">Thick and Stiff</span>
                    </div>
                    <div class="ideal-range"
                         style="left: calc((0.5 - 0) / (2 - 0) * 100%);
                                width: calc((1.5 - 0.5) / (2 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="2" value="0"
                           class="windowpane-slider" step="0.01"
                           data-ideal-min="0.5" data-ideal-max="1.5">
                    <div class="slider-labels">
                        <span>Thick and Stiff</span>
                        <span>Strong and Translucent</span>
                        <span>Weak</span>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="slider-title">
                        Smell: <span class="smell-value">Floury</span>
                    </div>
                    <div class="ideal-range"
                         style="left: calc((1 - 0) / (4 - 0) * 100%);
                                width: calc((3 - 1) / (4 - 0) * 100%);">
                    </div>
                    <input type="range" min="0" max="4" value="0"
                           class="smell-slider" step="0.01"
                           data-ideal-min="1" data-ideal-max="3">
                    <div class="slider-labels">
                        <span>Floury</span>
                        <span>Ripe</span>
                        <span>Sweet</span>
                        <span>Acidic</span>
                        <span>Starter-like</span>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <div id="boxes-container"></div>

    <script>
        /**************************************************
         *   Arrays for special text-based slider values  *
         **************************************************/
        const domedOnTopValues = ["Flat", "Low", "High", "Deflated"];
        const bubblesOnTopValues = ["None", "Few", "Many", "Deflated"];
        const bubblesOnSidesValues = ["None", "Few", "Many", "Deflated"];
        const wobbleTestValues = ["Stiff", "Loose and Aerated", "Liquified"];
        const windowpaneValues = ["Thick and Stiff", "Strong and Translucent", "Weak"];
        const smellValues = ["Floury", "Ripe", "Sweet", "Acidic", "Starter-like"];

        /**************************************************
         *   Helper: Get the slider's key                 *
         **************************************************/
        // Now looks for classes matching e.g. "temperature-slider-1"
        // That means everything ending with `-slider-<digit(s)>`
        function getSliderKey(slider) {
            const match = Array.from(slider.classList).find(cls => cls.match(/-slider-\d+$/));
            return match || 'unknown-slider';
        }

        /**************************************************
         *   Slider update logic                          *
         **************************************************/
        function updateSliderValue(slider, valueElement) {
            const sliderKey = getSliderKey(slider);
            // console.log(`[updateSliderValue] sliderKey=${sliderKey}, value=${slider.value}`);

            const idealMin = parseFloat(slider.getAttribute('data-ideal-min'));
            const idealMax = parseFloat(slider.getAttribute('data-ideal-max'));

            // Display numeric value by default
            valueElement.innerText = slider.value;

            // Update color
            if (slider.value < idealMin || slider.value > idealMax) {
                slider.style.setProperty('--slider-thumb-color', 'red');
            } else {
                slider.style.setProperty('--slider-thumb-color', '#4CAF50');
            }

            // For certain sliders, show descriptive text
            if (valueElement.classList.contains("domed-on-top-value")) {
                valueElement.innerText = domedOnTopValues[Math.round(slider.value)];
            } else if (valueElement.classList.contains("bubbles-on-top-value")) {
                valueElement.innerText = bubblesOnTopValues[Math.round(slider.value)];
            } else if (valueElement.classList.contains("bubbles-on-sides-value")) {
                valueElement.innerText = bubblesOnSidesValues[Math.round(slider.value)];
            } else if (valueElement.classList.contains("wobble-test-value")) {
                valueElement.innerText = wobbleTestValues[Math.round(slider.value)];
            } else if (valueElement.classList.contains("windowpane-value")) {
                valueElement.innerText = windowpaneValues[Math.round(slider.value)];
            } else if (valueElement.classList.contains("smell-value")) {
                valueElement.innerText = smellValues[Math.round(slider.value)];
            }
        }

        // Initialize each slider
        function initializeSlider(slider) {
            const sliderKey = getSliderKey(slider);
            // Find the matching value element, e.g. "temperature-value-1"
            const valueClass = sliderKey.replace("slider", "value");
            const valueElement = slider.parentElement.querySelector(`.${valueClass}`);

            // Update once on page load
            updateSliderValue(slider, valueElement);

            // Update on input change
            slider.addEventListener('input', () => {
                updateSliderValue(slider, valueElement);
            });
        }

        /**************************************************
         *   DOMContentLoaded: Clone boxes & rename classes
         **************************************************/
        document.addEventListener('DOMContentLoaded', () => {
            const template = document.getElementById('box-template');
            const container = document.getElementById('boxes-container');

            // Create 8 boxes
            for (let i = 0; i < 8; i++) {
                const clone = document.importNode(template.content, true);

                // Update "CheckX" label
                clone.querySelector('.sequence-number').innerText = i + 1;

                // 1) Append the clone to container first
                container.appendChild(clone);

                // 2) Rename all slider classes inside THIS clone to be unique, e.g. "temperature-slider-1"
                const rangeInputs = container
                    .querySelectorAll('.box')[i]
                    .querySelectorAll('input[type="range"]');

                rangeInputs.forEach(rng => {
                    // Original base class (e.g. "temperature-slider")
                    const baseClass = Array.from(rng.classList).find(c => c.endsWith('-slider'));
                    if (baseClass) {
                        // Remove the old class
                        rng.classList.remove(baseClass);
                        // Add the new unique class
                        rng.classList.add(`${baseClass}-${i+1}`);

                        // Also rename the "value" element (e.g. "temperature-value" → "temperature-value-1")
                        const oldValueClass = baseClass.replace('slider','value');
                        const valEl = rng.parentElement.querySelector(`.${oldValueClass}`);
                        if (valEl) {
                            valEl.classList.remove(oldValueClass);
                            valEl.classList.add(`${oldValueClass}-${i+1}`);
                        }
                    }
                });
            }

            // Now initialize all sliders with their new unique class names
            const allSliders = document.querySelectorAll('input[type="range"]');
            allSliders.forEach(initializeSlider);

            // Populate the dropdown with any existing localStorage titles
            loadSavedDataNames();
        });

        /**************************************************
         *   Saving, Loading, and Deleting Data           *
         **************************************************/
        function saveSliderData() {
            const title = document.getElementById('title').value.trim();
            if (!title) {
                alert("Please enter a title before saving.");
                return;
            }

            // Gather slider values
            const sliders = document.querySelectorAll('input[type="range"]');
            const datePickers = document.querySelectorAll('.datetime-picker');
            const data = { sliders: {}, datePickers: [] };

            // Store each slider under its unique key, e.g. "temperature-slider-1"
            sliders.forEach(slider => {
                const sliderKey = getSliderKey(slider);
                data.sliders[sliderKey] = slider.value;
            });

            datePickers.forEach(picker => {
                data.datePickers.push(picker.value);
            });

            const objToStore = { title, data };
            // console.log("[saveSliderData] Data to store:", objToStore);

            localStorage.setItem(title, JSON.stringify(objToStore));
            alert("Data saved!");
            loadSavedDataNames();
        }

        function loadSavedDataNames() {
            const savedDataList = document.getElementById('savedDataList');
            savedDataList.innerHTML = "";

            // Default prompt option
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select One";
            savedDataList.appendChild(defaultOption);

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key !== null) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    savedDataList.appendChild(option);
                }
            }
        }

        function loadSliderData() {
            const selectedKey = document.getElementById('savedDataList').value;
            if (!selectedKey) {
                alert("Please select a data set to load.");
                return;
            }

            const savedDataJSON = localStorage.getItem(selectedKey);
            if (!savedDataJSON) {
                alert("No data found for the selected title.");
                return;
            }

            const savedData = JSON.parse(savedDataJSON);
            const { title, data } = savedData;

            // Set the Title field
            document.getElementById('title').value = title;

            // Update each slider from stored data
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(slider => {
                const sliderKey = getSliderKey(slider);
                if (data.sliders.hasOwnProperty(sliderKey)) {
                    slider.value = data.sliders[sliderKey];
                    // Reflect the new value visually
                    const valueClass = sliderKey.replace("slider", "value");
                    const valueElement = slider.parentElement.querySelector(`.${valueClass}`);
                    updateSliderValue(slider, valueElement);
                }
            });

            // Update date/time pickers
            const datePickers = document.querySelectorAll('.datetime-picker');
            datePickers.forEach((picker, index) => {
                picker.value = data.datePickers[index] || "";
            });
        }

        function deleteSliderData() {
            const selectedKey = document.getElementById('savedDataList').value;
            if (!selectedKey) {
                alert("Please select a data set to delete.");
                return;
            }

            localStorage.removeItem(selectedKey);
            alert("Data deleted!");
            loadSavedDataNames();
        }

        /**************************************************
         *   Button Listeners                             *
         **************************************************/
        document.getElementById('saveButton').addEventListener('click', saveSliderData);
        document.getElementById('retrieveDataButton').addEventListener('click', loadSliderData);
        document.getElementById('deleteDataButton').addEventListener('click', deleteSliderData);

        document.getElementById('clearButton').addEventListener('click', () => {
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(slider => {
                slider.value = slider.min;
                const valueClass = getSliderKey(slider).replace("slider", "value");
                const valueElement = slider.parentElement.querySelector(`.${valueClass}`);
                updateSliderValue(slider, valueElement);
            });

            const datePickers = document.querySelectorAll('.datetime-picker');
            datePickers.forEach(picker => picker.value = '');
        });
    </script>
</body>
</html>
